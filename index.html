<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SQS Test System</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="shell">
    <div class="card">
      <header class="section-header">
        <div class="language-row">
          <label for="languageSelector" id="language_label"></label>
          <select id="languageSelector">
            <option value="en">English</option>
            <option value="fi">Suomi</option>
            <option value="jp">日本語</option>
          </select>
        </div>
        <h1 id="title_main">SQS — Structural Intelligence Quotient Test</h1>
        <p class="lead" id="lead_text">Single-page flow for introduction, self-assessment, module tasks, and results.</p>
      </header>

      <div id="page_intro" class="page-section">
        <h2 id="intro_heading">Introduction</h2>
        <div id="intro_content" class="question_block"></div>
        <div class="actions">
          <button type="button" id="btn_intro_continue">Continue</button>
        </div>
      </div>

      <div id="page_self_assessment" class="page-section">
        <h2 id="self_heading">Self-Assessment</h2>
        <div id="self_assessment_container"></div>
        <div class="actions">
          <button type="button" id="btn_self_assessment_continue">Continue to Modules</button>
        </div>
      </div>

      <div id="page_test_fl" class="page-section">
        <h2 data-domain="fl">Module: FL</h2>
        <div class="module_container" data-module="fl"></div>
        <div class="actions">
          <button type="button" id="btn_fl_finish">Finish Module</button>
        </div>
      </div>

      <div id="page_test_rr" class="page-section">
        <h2 data-domain="rr">Module: RR</h2>
        <div class="module_container" data-module="rr"></div>
        <div class="actions">
          <button type="button" id="btn_rr_finish">Finish Module</button>
        </div>
      </div>

      <div id="page_test_mf" class="page-section">
        <h2 data-domain="mf">Module: MF</h2>
        <div class="module_container" data-module="mf"></div>
        <div class="actions">
          <button type="button" id="btn_mf_finish">Finish Module</button>
        </div>
      </div>

      <div id="page_test_sc" class="page-section">
        <h2 data-domain="sc">Module: SC</h2>
        <div class="module_container" data-module="sc"></div>
        <div class="actions">
          <button type="button" id="btn_sc_finish">Finish Module</button>
        </div>
      </div>

      <div id="page_test_ph" class="page-section">
        <h2 data-domain="ph">Module: PH</h2>
        <div class="module_container" data-module="ph"></div>
        <div class="actions">
          <button type="button" id="btn_ph_finish">Finish Module</button>
        </div>
      </div>

      <div id="page_test_ssc" class="page-section">
        <h2 data-domain="ssc">Module: SSC</h2>
        <div class="module_container" data-module="ssc"></div>
        <div class="actions">
          <button type="button" id="btn_ssc_finish">Finish Module</button>
        </div>
      </div>

      <div id="page_results" class="page-section">
        <h2 id="results_heading">Results</h2>
        <div id="results_container"></div>
      </div>
    </div>
  </div>

  <script>
    const languageOptions = {
      en: 'English',
      fi: 'Suomi',
      jp: '日本語',
    };

    let LANG = {};
    let defaultLang = {};
    let statements = {};
    let defaultStatements = {};

    let currentLang = 'en';
    let currentPage = 'page_intro';

    const moduleOrder = ['fl', 'rr', 'mf', 'sc', 'ph', 'ssc'];

    const sqsResults = {
      fl: [],
      rr: [],
      mf: [],
      sc: [],
      ph: [],
      ssc: [],
    };

    let selectedTasks = {
      fl: [],
      rr: [],
      mf: [],
      sc: [],
      ph: [],
      ssc: [],
    };

    let selfScores = { fl: [], rr: [], mf: [], sc: [], ph: [], ssc: [] };

    async function fetchJSON(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to load ${url}`);
      return response.json();
    }

    function t(key, replacements = {}) {
      const langPack = Object.keys(LANG).length ? LANG : defaultLang;
      const fallback = defaultLang;
      const value = (langPack && typeof langPack[key] !== 'undefined' ? langPack[key] : fallback?.[key]) ?? '';
      if (typeof value !== 'string') return value;
      return Object.entries(replacements).reduce((acc, [k, v]) => acc.replace(`{${k}}`, v), value);
    }

    function getDomainLabel(domain) {
      const langPack = Object.keys(LANG).length ? LANG : defaultLang;
      const fallback = defaultLang;
      return langPack?.domainLabels?.[domain] ?? fallback?.domainLabels?.[domain] ?? domain.toUpperCase();
    }

    function showPage(id) {
      document.querySelectorAll('.page-section').forEach((el) => {
        el.style.display = 'none';
      });
      const target = document.getElementById(id);
      if (target) {
        target.style.display = 'block';
        currentPage = id;
      }
    }

    async function loadModuleTasks(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to load tasks');
      const data = await response.json();
      return Array.isArray(data) ? data : [];
    }

    function shuffle(array) {
      const copy = [...array];
      for (let i = copy.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function takeRandom(source, count) {
      const pool = [...source];
      const result = [];
      while (pool.length && result.length < count) {
        const idx = Math.floor(Math.random() * pool.length);
        result.push(pool.splice(idx, 1)[0]);
      }
      return result;
    }

    function selectTenTasks(allTasks) {
      const selected = [];
      const remaining = [...allTasks];

      for (let level = 1; level <= 4; level += 1) {
        const matches = remaining.filter((task) => task.difficulty === level);
        const picks = takeRandom(matches, 2);
        selected.push(...picks);
        picks.forEach((pick) => {
          const idx = remaining.findIndex((t) => t.id === pick.id);
          if (idx >= 0) remaining.splice(idx, 1);
        });
      }

      const extras = takeRandom(remaining, 2);
      selected.push(...extras);

      return shuffle(selected).slice(0, 10);
    }

    class ModuleRunner {
      constructor(moduleId, nextPageId) {
        this.moduleId = moduleId;
        this.nextPageId = nextPageId;
        this.tasks = [];
        this.answers = [];
        this.container = document.querySelector(`#page_test_${moduleId} .module_container`);
      }

      async start() {
        if (!this.container) return;
        this.container.innerHTML = `<div class="question_block">${t('loadingTasks')}</div>`;
        try {
          const jsonUrl = `lang/${currentLang}/tasks_${this.moduleId}.json`;
          const allTasks = await loadModuleTasks(jsonUrl);
          this.tasks = selectTenTasks(allTasks);
          selectedTasks[this.moduleId] = this.tasks;
          this.answers = new Array(this.tasks.length).fill(null);
          this.renderAllTasks();
        } catch (err) {
          this.container.innerHTML = `<div class="question_block">${t('tasksLoadError')}</div>`;
        }
      }

      renderAllTasks() {
        if (!this.container || !this.tasks.length) return;
        this.container.innerHTML = '';

        this.tasks.forEach((task, idx) => {
          const block = document.createElement('div');
          block.className = 'question_block';

          const title = document.createElement('div');
          title.className = 'question_title';
          title.textContent = `${idx + 1}. ${task.question}`;
          block.appendChild(title);

          const optionsWrapper = document.createElement('div');
          optionsWrapper.className = 'options';

          if (task.options && task.options.length >= 4) {
            task.options.slice(0, 4).forEach((opt, optIdx) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'optionButton';
              btn.textContent = `${String.fromCharCode(65 + optIdx)}. ${opt}`;
              if (this.answers[idx] === optIdx) {
                btn.classList.add('selected');
              }
              btn.addEventListener('click', () => {
                this.recordAnswer(idx, optIdx);
                optionsWrapper.querySelectorAll('button').forEach((b) => b.classList.remove('selected'));
                btn.classList.add('selected');
              });
              optionsWrapper.appendChild(btn);
            });
          } else {
            optionsWrapper.textContent = t('missingOptions');
          }

          block.appendChild(optionsWrapper);
          this.container.appendChild(block);
        });
      }

      recordAnswer(taskIndex, choiceIndex) {
        this.answers[taskIndex] = choiceIndex;
      }

      finishModule() {
        sqsResults[this.moduleId] = this.answers;
        showPage(this.nextPageId);
        const nextModuleId = this.nextPageId.replace('page_test_', '');
        if (modules[nextModuleId]) {
          modules[nextModuleId].start();
        }
        if (this.nextPageId === 'page_results') {
          renderResults();
        }
      }
    }

    const modules = {
      fl: new ModuleRunner('fl', 'page_test_rr'),
      rr: new ModuleRunner('rr', 'page_test_mf'),
      mf: new ModuleRunner('mf', 'page_test_sc'),
      sc: new ModuleRunner('sc', 'page_test_ph'),
      ph: new ModuleRunner('ph', 'page_test_ssc'),
      ssc: new ModuleRunner('ssc', 'page_results'),
    };

    async function loadIntroText() {
      const container = document.getElementById('intro_content');
      if (!container) return;
      container.textContent = t('loadingIntro') || 'Loading introduction...';
      try {
        const response = await fetch(`lang/${currentLang}/SQS.md`);
        if (!response.ok) throw new Error('Unable to load intro');
        const text = await response.text();
        container.textContent = text;
      } catch (err) {
        container.textContent = t('introLoadError') || 'Unable to load introduction.';
      }
    }

    function renderSelfAssessment() {
      const container = document.getElementById('self_assessment_container');
      if (!container) return;
      container.innerHTML = '';

      moduleOrder.forEach((domain) => {
        const statementsForDomain = statements?.[domain] ?? defaultStatements?.[domain] ?? [];
        if (!Array.isArray(statementsForDomain) || !statementsForDomain.length) return;

        if (!Array.isArray(selfScores[domain]) || !selfScores[domain].length) {
          selfScores[domain] = new Array(statementsForDomain.length).fill(null);
        } else if (selfScores[domain].length < statementsForDomain.length) {
          selfScores[domain].length = statementsForDomain.length;
          selfScores[domain] = selfScores[domain].map((v) => (typeof v === 'undefined' ? null : v));
        }

        const section = document.createElement('div');
        section.className = 'question_block';

        const title = document.createElement('div');
        title.className = 'question_title';
        title.textContent = `${getDomainLabel(domain)} ${t('selfAssessmentSuffix')}`;
        section.appendChild(title);

        statementsForDomain.forEach((statement, idx) => {
          const row = document.createElement('div');
          row.className = 'likert-row';

          const label = document.createElement('div');
          label.className = 'likert-label';
          label.textContent = `${idx + 1}. ${statement}`;
          row.appendChild(label);

          const options = document.createElement('div');
          options.className = 'likert-options';

          for (let score = 1; score <= 7; score += 1) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'likert-button';
            btn.textContent = score;
            btn.addEventListener('click', () => {
              selfScores[domain][idx] = score;
              options.querySelectorAll('button').forEach((b) => b.classList.remove('selected'));
              btn.classList.add('selected');
            });
            if (selfScores[domain][idx] === score) {
              btn.classList.add('selected');
            }

            options.appendChild(btn);
          }

          row.appendChild(options);
          section.appendChild(row);
        });

        container.appendChild(section);
      });
    }

    function attachModuleFinishHandlers() {
      document.getElementById('btn_fl_finish')?.addEventListener('click', () => modules.fl.finishModule());
      document.getElementById('btn_rr_finish')?.addEventListener('click', () => modules.rr.finishModule());
      document.getElementById('btn_mf_finish')?.addEventListener('click', () => modules.mf.finishModule());
      document.getElementById('btn_sc_finish')?.addEventListener('click', () => modules.sc.finishModule());
      document.getElementById('btn_ph_finish')?.addEventListener('click', () => modules.ph.finishModule());
      document.getElementById('btn_ssc_finish')?.addEventListener('click', () => modules.ssc.finishModule());
    }

    function computeSelfAverages() {
      const averages = {};
      Object.entries(selfScores).forEach(([domain, scores]) => {
        const validScores = (scores || []).filter((val) => val !== null && typeof val !== 'undefined');
        if (!validScores.length) {
          averages[domain] = t('notProvided');
        } else {
          const sum = validScores.reduce((acc, val) => acc + Number(val), 0);
          averages[domain] = (sum / validScores.length).toFixed(2);
        }
      });
      return averages;
    }

    function computeAbilityScores() {
      const abilities = {};
      Object.entries(sqsResults).forEach(([domain, answers]) => {
        const tasks = selectedTasks[domain] || [];
        let correctCount = 0;
        answers.forEach((answerIdx, i) => {
          const task = tasks[i];
          if (task && Number(task.correctIndex) === Number(answerIdx)) correctCount += 1;
        });
        abilities[domain] = tasks.length ? ((correctCount / 10) * 100).toFixed(0) : '0';
      });
      return abilities;
    }

    function renderResults() {
      const container = document.getElementById('results_container');
      if (!container) return;
      const selfAvg = computeSelfAverages();
      const abilityScores = computeAbilityScores();

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      (t('tableHeaders') || []).forEach((label) => {
        const th = document.createElement('th');
        th.textContent = label;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      moduleOrder.forEach((domain) => {
        const row = document.createElement('tr');
        const domainCell = document.createElement('td');
        domainCell.textContent = getDomainLabel(domain);
        const selfCell = document.createElement('td');
        selfCell.textContent = selfAvg[domain] ?? t('notProvided');
        const abilityCell = document.createElement('td');
        abilityCell.textContent = abilityScores[domain] ?? '0';
        row.appendChild(domainCell);
        row.appendChild(selfCell);
        row.appendChild(abilityCell);
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      container.innerHTML = '';
      container.appendChild(table);
    }

    function applyLanguage() {
      const langPack = Object.keys(LANG).length ? LANG : defaultLang;
      if (!langPack) return;
      document.documentElement.lang = currentLang;
      document.title = langPack.pageTitle || '';

      document.getElementById('language_label').textContent = langPack.languageLabel || '';
      document.getElementById('title_main').textContent = langPack.title || '';
      document.getElementById('lead_text').textContent = langPack.lead || '';
      document.getElementById('intro_heading').textContent = langPack.introHeading || '';
      document.getElementById('self_heading').textContent = langPack.selfHeading || '';
      document.getElementById('results_heading').textContent = langPack.resultsHeading || '';

      document.getElementById('btn_intro_continue').textContent = langPack.introContinue || '';
      document.getElementById('btn_self_assessment_continue').textContent = langPack.selfContinue || '';

      document.querySelectorAll('#page_intro button, #page_self_assessment button').forEach((btn) => {
        btn.setAttribute('aria-label', btn.textContent);
      });

      document.querySelectorAll('[id^="page_test_"] h2[data-domain]').forEach((heading) => {
        const domain = heading.getAttribute('data-domain');
        heading.textContent = t('moduleTitle', { module: getDomainLabel(domain) });
      });

      document
        .querySelectorAll('#page_test_fl button, #page_test_rr button, #page_test_mf button, #page_test_sc button, #page_test_ph button, #page_test_ssc button')
        .forEach((btn) => {
          btn.textContent = langPack.finishModule || '';
        });

      const selector = document.getElementById('languageSelector');
      if (selector) selector.value = currentLang;

      renderSelfAssessment();
    }

    async function loadLang(code) {
      currentLang = code;
      try {
        LANG = await fetchJSON(`lang/${code}/lang.json`);
        if (!Object.keys(defaultLang).length && code === 'en') defaultLang = LANG;
      } catch (err) {
        LANG = code === 'en' ? {} : defaultLang;
      }

      await loadIntroText();

      try {
        statements = await fetchJSON(`lang/${code}/statements.json`);
        if (!Object.keys(defaultStatements).length && code === 'en') defaultStatements = statements;
      } catch (err) {
        statements = code === 'en' ? {} : defaultStatements;
      }

      applyLanguage();
    }

    function setupLanguageSelector() {
      const selector = document.getElementById('languageSelector');
      if (!selector) return;
      selector.innerHTML = '';
      Object.entries(languageOptions).forEach(([value, label]) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label;
        selector.appendChild(option);
      });
      selector.value = currentLang;
      selector.addEventListener('change', (event) => {
        loadLang(event.target.value);
      });
    }

    async function setupFlow() {
      setupLanguageSelector();
      await loadLang('en');
      showPage(currentPage);
      attachModuleFinishHandlers();

      document.getElementById('btn_intro_continue')?.addEventListener('click', () => {
        showPage('page_self_assessment');
      });

      document.getElementById('btn_self_assessment_continue')?.addEventListener('click', () => {
        modules.fl.start();
        showPage('page_test_fl');
      });
    }

    window.addEventListener('DOMContentLoaded', setupFlow);
  </script>
</body>
</html>
